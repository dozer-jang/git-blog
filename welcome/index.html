<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/git-blog/rss.xml" title="Dozer Tech Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/git-blog/atom.xml" title="Dozer Tech Blog Blog Atom Feed"><title data-react-helmet="true">Kubernetes Networking (1) | Dozer Tech Blog</title><meta data-react-helmet="true" property="og:title" content="Kubernetes Networking (1) | Dozer Tech Blog"><meta data-react-helmet="true" name="description" content="쿠버네티스를 공부하면서 CNI가 도대체 무엇인지 궁금해서 여러 가지 자료를 취합하다가 한번 흐름대로 정리할 필요를 느껴서 작성한 글입니다. 잘못된 내용이 전달될 가능성이 있습니다."><meta data-react-helmet="true" property="og:description" content="쿠버네티스를 공부하면서 CNI가 도대체 무엇인지 궁금해서 여러 가지 자료를 취합하다가 한번 흐름대로 정리할 필요를 느껴서 작성한 글입니다. 잘못된 내용이 전달될 가능성이 있습니다."><meta data-react-helmet="true" property="og:url" content="https://dozer-jang.github.io/git-blog/welcome"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/git-blog/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://dozer-jang.github.io/git-blog/welcome"><link data-react-helmet="true" rel="alternate" href="https://dozer-jang.github.io/git-blog/welcome" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://dozer-jang.github.io/git-blog/welcome" hreflang="x-default"><link rel="stylesheet" href="/git-blog/assets/css/styles.fa22310d.css">
<link rel="preload" href="/git-blog/assets/js/styles.2f72082b.js" as="script">
<link rel="preload" href="/git-blog/assets/js/runtime~main.2b3849cf.js" as="script">
<link rel="preload" href="/git-blog/assets/js/main.5527cec5.js" as="script">
<link rel="preload" href="/git-blog/assets/js/1.182e10f4.js" as="script">
<link rel="preload" href="/git-blog/assets/js/2.b87ccbee.js" as="script">
<link rel="preload" href="/git-blog/assets/js/ccc49370.72804eca.js" as="script">
<link rel="preload" href="/git-blog/assets/js/3c395d36.94ffa9bf.js" as="script">
<link rel="preload" href="/git-blog/assets/js/5cc72a3e.4a589bba.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/git-blog/"><img src="/git-blog/img/logo.png" alt="Dozer Blog" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/git-blog/img/logo.png" alt="Dozer Blog" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Dozer</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/git-blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/dozer-jang" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/git-blog/"><img src="/git-blog/img/logo.png" alt="Dozer Blog" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/git-blog/img/logo.png" alt="Dozer Blog" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Dozer</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/git-blog/">Blog</a></li><li class="menu__list-item"><a href="https://github.com/dozer-jang" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/git-blog/welcome">Kubernetes Networking (1)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/git-blog/2021/03/30/Test">Test</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">Kubernetes Networking (1)</h1><div class="margin-vert--md"><time datetime="2021-04-28T00:00:00.000Z" class="blogPostDate_fNvV">April 28, 2021</time></div><div class="avatar margin-vert--md"><a href="https://github.com/dozer-jang" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://raw.githubusercontent.com/dozer-jang/dozer-jang.github.io/main/static/img/author/author.png" alt="Dozer"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/dozer-jang" target="_blank" rel="noopener noreferrer">Dozer</a></h4><small class="avatar__subtitle">Dozer</small></div></div></header><div class="markdown"><p>쿠버네티스를 공부하면서 CNI가 도대체 무엇인지 궁금해서 여러 가지 자료를 취합하다가 한번 흐름대로 정리할 필요를 느껴서 작성한 글입니다. <strong>잘못된 내용이 전달될 가능성이 있습니다.</strong></p><p>아래 내용은 A Guide to the Kubernetes Networking Model를 매우 많이 참조했다.</p><p>일단 쿠버네티스에서 말하는 클러스터 네트워킹에는 네 가지 종류가 존재한다. </p><ol><li>Highly-coupled container-to-container communications</li><li><strong>Pod-to-Pod communications</strong></li><li>Pod-to-Service communications</li><li>External-to-Service communications</li></ol><p>이번에 살펴볼 부분은 <strong>Pod-to-Pod</strong> 네트워킹이다. Pod to Pod 네트워킹에는 세 가지 원칙이 존재한다. 그 중 첫 번째 특징인 모든 Pod는 어느 Node(VM)있는 Pod들과 통신할 때 NAT를 필요로 하지 않는다 것이 가장 핵심적인 부분이라고 할 수 있는데 이 글은 그 부분에 대해서 살펴본다.</p><ul><li><strong>pods on a node can communicate with all pods on all nodes without NAT</strong></li><li>agents on a node (e.g. system daemons, kubelet) can communicate with all pods on that node</li></ul><p>Note: For those platforms that support <code>Pods</code> running in the host network (e.g. Linux):</p><ul><li><p>pods in the host network of a node can communicate with all pods on all nodes without NAT</p><p>쿠버네티스 노드를 이루는 하나의 VM을 생각해보았을 때 다음과 같이 <code>eht0</code>가 붙어있는 경우를 일반적으로 떠올릴 수 있다. 리눅스 내에서 실행하는 프로세스들이 외부와 통신할 때 보통 이 <code>eth0</code> 인터페이스를 이용해서 나가게 된다.</p></li></ul><p align="center"><img alt="1.png" src="/git-blog/img/post/kubernetes-networking/1.png"></p><p> 사실 VM에 붙어있는 <code>eth0</code>의 경우 엄밀히는 root network namespace에 존재한다고 말할 수 있다. 일반적으로 namespace란 용어가 격리된 환경을 제공하는 의미로 쓰이듯, root network namespace란 VM 내부의 모든 프로세스들이 사용하는 네트워크 환경이다. </p><p align="center"><img alt="2.png" src="/git-blog/img/post/kubernetes-networking/2.png"></p>이제 이 VM에 Pod가 존재하는 상황을 가정해볼 것이다.<p>쿠버네티스 공식 문서의 Pod에 대한 설명에는 다음과 같은 문장이 있다.</p><blockquote><p>The shared context of a Pod is a set of Linux namespaces, cgroups, and potentially other facets of isolation. <em>(생략)</em></p></blockquote><p><em>Pod의 공유 컨텍스트는 Linux namespace, cgroup 및 잠재적으로 다른 격리 측면의 집합이다.</em></p><p>번역을 정확히 이해하기 어렵지만, Pod는 위에서 언급한 기술들로 일종의 격리된 환경에서 구성된다고 생각해본다.</p><p>그렇다면 VM에 하나의 Pod A가 존재한다면 Pod A은 Root network namespace와는 독립적인 Pod A network namespace에 존재한다. </p><p> 좀 더 나아가서 아래 그림과 같이 Pod A에 Container1(Ctr1)과 Container2(Ctr2)가 동시에 존재하는 다음과 같은 상황을 가정해보자. Pod에 존재하는 컨테이너들은 Pod에 할당된 network namespace을 서로 공유하고 해당 Pod network namespace에 할당된 IP와 port space를 공유합니다. 즉 이는 같은 Pod안의 컨테이너들은 서로를 <code>localhost:port</code> 를 통해서 통신이 가능하다는 것을 의미합니다. </p><p align="center"><img alt="3.png" src="/git-blog/img/post/kubernetes-networking/3.png"></p>다시 Pod의 네트워크를 생각해보겠습니다.<p> 쿠버네티스에서 Pod는 모두 각자의 IP를 갖고 있고 각자의 Pod들은 IP를 이용해서 통신한다. 이것을 &quot;IP-per-Pod&quot;라고 부릅니다. 그런데 Pod는 IP를 통해 서로 통신할 수 있다는 것은 어떤 의미일까요? </p><p> 일단 Pod가 같은 VM에 있는 다른 Pod에 통신하려는 경우가 있을 수 있습니다. Pod에겐 고유한 network namespace가 존재하고, 이 Pod network namespace와 VM내부의 다른 network namespace를 연결하기 위해 가상의 이더넷 케이블을 사용할 수 있습니다. veth pair<em>(Virtual Ethernet Device)</em>라고 불리는 이 인터페이스는 서로 다른 namespace를 연결하기 위해 한 쌍을 이루는 형태로 존재합니다. 아래 그림과 같이 한 쌍의 veth pair를 생성해서 한 쪽은 VM의 root network namespace에 연결하고, 한쪽은 Pod A의 network namespace에 연결해보겠습니다. 그리고 같은 작업을 Pod B에도 동일하게 적용하겠습니다.</p><p align="center"><img alt="4.png" src="/git-blog/img/post/kubernetes-networking/4.png"></p>이제 Pod A와 Pod B 모두 root network namespace에 트래픽을 보낼 수 있지만, 서로가 통신이 되는 상태는 아닙니다. veth1, veth3 모두 그저 root network namespace에 존재할 뿐입니다. 이를 위해서는 Linux Ethernet Bridge를 VM 내부에 생성합니다. Linux Ethernet Bridge는 우리가 흔히 알고 있는 Layer 2의 네트워크 디바이스인 스위치의 역할입니다.<p> 아래와 같이 br0 Bridge를 root network namespace에 생성해고 veth1, veth3를 br0에 붙인다. 그리고 Pod A에서 Pod B로 요청을 보낼 경우를 생각해보겠습니다.</p><p align="center"><img alt="5.png" src="/git-blog/img/post/kubernetes-networking/5.png"></p>1) Pod A에서 자신의 인터페이스로 veth0로 패킷을 보낸다. 해당 패킷은 veth 한 쌍의 반대쪽인 root ns의 veth1으로 흐르게 된다. 2,3) veth1은 bridge인 br0와 연결되어있으므로 br0는 연결되어있는 모든 인터페이스들에게 ARP 프로토콜을 통해 10.0.0.3의 맥어드레스를 찾는다. 4) 그렇게 veth2가 10.0.0.3임을 알게 되고 veth2로 패킷을 포워딩한다.<p align="center"><img alt="6.png" src="/git-blog/img/post/kubernetes-networking/6.png"></p>*위 그림에서 veth0은 eth0로 이름을 변경할 수 있습니다. 그러나 VM의 eth0와 구분하기 위해서 vethN으로 표시했습니다. eth0(veth0)은 그저 veth타입의 이더넷 인터페이스의 이름이 eth0인 것을 의미합니다.*<p> 정리하자면 Pod들은 자신들의 eth0 인터페이스만을 통해서도 다른 Pod와 자유롭게 통신할 수 있다는 것입니다. 이건 보통의 우리가 예상하는 네트워크의 동작과 같습니다. </p><p>하지만 Node들이 여러 대일 경우는 어떨까요?</p><p> 아래처럼 두개의 VM가 존재하고 VM 1의 Pod A(10.0.0.2)에서 VM 2의 Pod B(10.0.1.5)로 통신하는 경우를 생각해보겠습니다. 1) Pod A의 eht0(veth0)에서 veth1로 패킷을 보내고 2) veth1은 연결된 bridge인 br0에 패킷을 보냅니다. 3) br0은 목적지인 10.0.1.5에 대해서 ARP 프로토콜을 수행하지만 해당하는 IP를 갖는 인터페이스가 없으므로 실패하고 default gateway인 VM 1의 eth0에 패킷을 올립니다. 4,5) 하지만 VM 1을 떠난 패킷은 어디에도 가지 못합니다. 왜냐면 보통 VM들은 anti-spoofing protection이 활성화되어있습니다. anti-spoofing은 네트워크가 알고있지 않은 source IP를 가진 패킷은 드랍시키는 것을 의미합니다. 여기서 source IP는 Pod A의 10.0.0.2이고 이 IP는 VM의 네트워크에서는 알지 못하는 IP입니다. <em>(보통의 CSP들은 VM에 anti-spoofing protection이 활성화되어있다. 하지만 GKE와 같은 매니지드 서비스를 사용해서 k8s 클러스터를 생성할 때는 VM의 anti-spoofing protection을 비활성화해서 제공합니다.).</em></p><p align="center"><img alt="7.png" src="/git-blog/img/post/kubernetes-networking/7.png"></p>그렇다면 GCP의 예를 이어서, 다음과 같은 명령어를 이용했다고 가정해보겠습니다.<div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly jsx"><div tabindex="0" class="prism-code language-jsx codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ gcloud compute instances create vm2 </span><span class="token operator" style="color:rgb(137, 221, 255)">--</span><span class="token plain">can</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">ip</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">forward</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ gcloud compute routes create vm2 </span><span class="token operator" style="color:rgb(137, 221, 255)">--</span><span class="token plain">destination</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">range</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10.0</span><span class="token number" style="color:rgb(247, 140, 108)">.1</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token number" style="color:rgb(247, 140, 108)">24</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">--</span><span class="token plain">next</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">hop</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">instacne</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">vm2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>첫 번째 명령어는 VM을 생성할때 anti-spoofing을 비활성화하겠다는 것이고 두 번째 명령어는 목적지가 10.0.1.0/24 대역에 속하면 VM 2으로 패킷을 포워딩하라는 뜻입니다.</p><p align="center"><img alt="8.png" src="/git-blog/img/post/kubernetes-networking/8.png"></p>그렇다면 다시 돌아와서 이제는 정상적으로  Pod A에서 Pod D로 패킷이 전송 가능합니다. 3)까지의 상황은 이전 그림과 같기 때문에 변경된 부분부터 살펴보자면 4) 패킷이 정상적으로 VM 1을 떠나게 되고 5)위에서 설정한 라우팅 규칙에 따라서 VM 2로 포워딩 됩니다. 6)그럼 VM 2의 eht0 들어온 패킷은 br0 bridge로 전해지고 7) br0의 ARP 프로토콜이 성공하고 8) 목적지인 Pod D로 패킷이 전달됩니다.<p>여기서 다시 한번 주목할 점은 패킷의 source, destination이 바뀌지 않았다는 것입니다. 이건 보통의 우리가 생각하는 네트워크의 정상적인 작동입니다.</p><p>하지만 아직 아쉬운 설명들이 많다. VM(Node)와  Pod 모두 ephemeral 성격을 갖습니다. 그 말인즉슨 Pod는 사라졌다가 다시 띄워질 수도 있고, VM 또한 리소스가 필요할 시 늘어날 수 있고 또 반대로 줄어들 수도 있죠. </p><p>그렇다면 새로 뜨는 VM에 존재하는 Pod들은 어떤 IP대역대를 갖고 있을까요? 그리고 그 정보를 매번 VM 네트워크에 알려줘야 할까요? </p><p>다음 글에서 좀 더 CNI에 대해서 알아보겠다.</p><p>Ref.</p><p>The ins and outs of networking in Google Container Engine and Kubernetes (Google Cloud Next &#x27;17)
<a href="https://www.youtube.com/watch?v=y2bhV81MfKQ&amp;list=WL&amp;index=16" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=y2bhV81MfKQ&amp;list=WL&amp;index=16</a></p><p>A Guide to the Kubernetes Networking Model - Kevin Sookocheff</p><p><a href="https://sookocheff.com/post/kubernetes/understanding-kubernetes-networking-model/" target="_blank" rel="noopener noreferrer">https://sookocheff.com/post/kubernetes/understanding-kubernetes-networking-model/</a></p><p><a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/concepts/cluster-administration/networking/</a></p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/git-blog/tags/kubernetes">Kubernetes</a><a class="margin-horiz--sm" href="/git-blog/tags/network">Network</a><a class="margin-horiz--sm" href="/git-blog/tags/pod">Pod</a><a class="margin-horiz--sm" href="/git-blog/tags/cni">CNI</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/git-blog/2021/03/30/Test"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Test »</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/dotat-jang" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/git-blog/assets/js/styles.2f72082b.js"></script>
<script src="/git-blog/assets/js/runtime~main.2b3849cf.js"></script>
<script src="/git-blog/assets/js/main.5527cec5.js"></script>
<script src="/git-blog/assets/js/1.182e10f4.js"></script>
<script src="/git-blog/assets/js/2.b87ccbee.js"></script>
<script src="/git-blog/assets/js/ccc49370.72804eca.js"></script>
<script src="/git-blog/assets/js/3c395d36.94ffa9bf.js"></script>
<script src="/git-blog/assets/js/5cc72a3e.4a589bba.js"></script>
</body>
</html>